{% extends "main/base.html" %}

{% block content %}
<div>
    <div class="container-fluid px-5">
        <div class="row my-3 pb-2 bg-white shadow">
            <!-- Displayed before variant table data is loaded
                or when no data is found (text is updated via a javascript). -->
            <p id="div-table-variants-no-data-message" class="pt-3 lead text-muted text-center">
                Looking for variant data...
            </p>
            <!-- Table <div> is hidden until it is fully loaded
                to display the custom loading message. -->
            <div id="div-table-variants" class="table-variants" hidden="hidden">
                <div class="row pt-1 align-items-center">
                    <div class="col col-auto">
                        <button id="clear-filters-btn" class="btn btn-secondary btn-sm" onclick="clearFilters()">
                            <i class="fas fa-rotate"></i>
                        </button>
                    </div>
                    <div class="col col-auto">
                        <div class="vr mt-1" style="height: 34px;"></div>
                    </div>
                    <div class="col col-auto">
                        <h6 class="px-0 m-0"><b>{{ search_value }}</b></h6>
                    </div>
                    <div class="col col-auto">
                        <div class="vr mt-1" style="height: 34px;"></div>
                    </div>
                    <div class="col col-auto">
                        <!-- var-count-text <span> is updated via a javascript 
                            to display number of variants (rows) in the table
                            after applying all filters. -->
                        <h6 class="px-0 m-0"><b>Variants:</b> <span id="var-count-text"></span></h6>
                    </div>
                    <div class="col col-auto ms-auto">
                        * Same nucleotide change
                    </div>
                </div>
                <div class="row">
                    <!-- Table options are described in the following doc:
                        https://bootstrap-table.com/docs/api/table-options/
                        The number of rows per page (18) was selected to 
                        display the table without the vertical scrolling bar
                        on 1920x1080 monitors when all rows height is one line. -->
                    <table id="table-variants"
                        data-toggle="table"
                        data-detail-view="true"
                        data-detail-formatter="detailFormatter"
                        data-sortable="true"
                        data-sort-name="pos"
                        data-search="true"
                        data-search-align="left"
                        data-search-selector="#customSearch"
                        data-ajax="ajaxRequest"
                        data-page-size="18"
                        data-pagination="true"
                        data-filter-control="true"
                        data-pagination-parts="['pageList']">
                        <thead>
                            <!-- Table column width configuration have the following quirks:
                                
                                If column "data-width" is not specified then it is automatically
                                adjusted to fit the overall table width taking into account
                                the width required to display other no-"data-width" columns
                                content without breaking it into multiple rows if possible.

                                If column "data-width" is less than required to display its
                                longest non-breakable word (string with no spaces), than it is
                                automatically increased to fit it.

                                To break a long word without spaces, a style with a fixed
                                "max-width" and "word-wrap: break-word" must be used.

                                if all columns have "data-width" specified but its total width
                                does not match the overall table width then "data-width"
                                properties are ignored.

                                Variant HGVS description in rare cases can be extremly long and
                                it does not contain spaces. To avoid horizontal table scrolling, 
                                "col-max-width-500" style is used to break it into multiple lines 
                                if needed. However, for the reasons described above, it will work
                                only when at least one other column does not have fixed "data-width".
                            -->
                            <tr class="primary">
                                <th data-field="chrom" data-filter-control="input" data-sortable="true" data-width="20" data-halign="center" data-align="center" data-valign="middle">Chrom</th>
                                <th data-field="pos" data-filter-control="input" data-sortable="true" data-width="20" data-halign="center" data-valign="middle">Position</th>
                                <th data-field="consequence" data-filter-control="input" data-width="200" data-sortable="true" data-halign="center" data-valign="middle">Consequence</th>
                                <th data-field="hgvs_c" data-filter-control="input" class="col-max-width-500" data-width="500" data-sortable="true" data-halign="center" data-valign="middle">HGVSc</th>
                                <th data-field="hgvs_p" data-filter-control="input" class="col-max-width-500" data-width="500" data-sortable="true" data-halign="center" data-valign="middle">HGVSp</th>
                                <th data-field="refseq_transcript" data-filter-control="input" data-sortable="true" data-halign="center" data-valign="middle">Transcript</th>
                                <th data-field="gene" data-filter-control="input" data-sortable="true" data-halign="center" data-valign="middle">Gene</th>
                                <th data-field="haemonc_cancers_count" data-sortable="true" data-width="27" data-halign="center" data-align="right" data-valign="middle">HaemOnc<br>patient count*</th>
                                <th data-field="all_cancers_count" data-sortable="true" data-width="20" data-halign="center" data-align="right" data-valign="middle">All cancers<br>patient count*</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    var $table = $('#table-variants');

    
    // Get variant extended row subtable ID.
    function getVariantCancerTypesSubtableID(variantID) {
        return `table-variant-cancer-types-${variantID}`
    }


    // Initialise variant table.
    $table.bootstrapTable({
        // Populates extended row subtable on demand. Official bootstrap-table doc:
        // https://bootstrap-table.com/docs/api/events/#onexpandrow
        onExpandRow: function (index, row) {
            // Get variant subtable ID and data url by variant db id.
            let $subtable = $('#' + getVariantCancerTypesSubtableID(row.variant_id));
            let url = `{% url 'main:ajax_variant_cancer_pcs' %}?variant_id=${row.variant_id}`;
            
            // Load variant cancer type patient counts subtable data using async request.
            $.get(url).then(function (res) {
                $subtable.bootstrapTable({
                    data: res.rows,
                    rowStyle: function (row, index) {
                        if (row.cancer_type === 'All Cancers' || row.cancer_type === 'Haemonc Cancers') {
                            return {
                                classes: 'fw-bold'  // Make aggregated cancer types bold
                            };
                        }
                        return {};
                    }
                })
                
                // Get all rows as array of objects.
                const data = $subtable.bootstrapTable('getData');
                // Get all visible columns.
                const columns = $subtable.bootstrapTable('getVisibleColumns');
                // Columns with no patients (zeroes) in all cancer types.
                const zeroColumns = [];
                // Columns to skip in zero-checks.
                const skipFields = ['cancer_type', 'is_haemonc'];
                
                columns.forEach(column => {
                    // Ignore non-numeric columns.
                    if (skipFields.includes(column.field)) return;

                    // Check if all values for this column are zero.
                    const allZero = data.every(row => {
                        const val = row[column.field];
                        // Treat null/undefined as zero.
                        return val === 0 || val === '0' || val === null || val === undefined;
                    });
                    // Add colum to the list of columns that are going to be hidden.
                    if (allZero) zeroColumns.push(column.field);
                });

                // Hide the zero columns.
                zeroColumns.forEach(field => {
                    $subtable.bootstrapTable('hideColumn', field);                
                })
                // Show the subtable once it is fully ready.
                $subtable.removeAttr('hidden');
            });
        }
    })


    // Clear all table filter controls.
    function clearFilters() {
        // Clear filters.
        $table.bootstrapTable('clearFilterControl');
        // Reload table data.
        $table.bootstrapTable('filterBy', {});
        // Update the displayed variant count.
        updateVariantCount();
    }


    // Update table variants (rows) count on the UI.
    function updateVariantCount() {
        $('#var-count-text').text($table.bootstrapTable('getOptions').totalRows.toLocaleString());
    }


    // Update table variants (rows) count after each table search.
    $table.on('search.bs.table', function (e, text) {
        updateVariantCount();
    });


    /**
     * Populates variant table with data. Official bootstrap-table doc:
     * https://bootstrap-table.com/docs/api/table-options/#ajax
     *  
     * @param {Object} - An object with additional bootsrap-table ajax 
     *                   request params (e.g. sort order).
     * @returns {void}
     */
    function ajaxRequest(params) {
        // Ajax url and search value are obtained from the backend.
        let url = '{{ variant_data_url|safe }}';
        let search_value = '{{ search_value }}';

        // Add any additional bootstrap-table parameters to the ajax
        // request and load variant table data.
        $.get(url + '&' + $.param(params.data)).then(function (res) {
            params.success(res);
            // If no variants were found for the provided search params,
            // update the "Looking for variant data..." message.
            if (res.total === 0) {
                $('#div-table-variants-no-data-message').text(`No variants were found for "${search_value}"`);
                if (res.error !== '') {
                    console.log(`Failed to process the variant query: "${res.error}"`)
                }
            } else {
                // Otherwise, hide the message, show the table, 
                // and update the displayed variants count.
                document.getElementById('div-table-variants').removeAttribute("hidden");
                document.getElementById('div-table-variants-no-data-message').setAttribute("hidden", "hidden");
                updateVariantCount();
            }
        })
    }


    /**
     * Generates variant table row's detail view content - a sub-table with 
     * various cancer types patient counts. Official bootstrap-table doc:
     * https://bootstrap-table.com/docs/api/table-options/#detailformatter
     * 
     * @param {number} - Row index
     * @param {Object} - Row data
     * @returns {string} - Row's detail view html
     */
    function detailFormatter(index, row) {
        let var_cancer_types_table_id = getVariantCancerTypesSubtableID(row['variant_id'])
        let html = `
            <table id="${var_cancer_types_table_id}" 
                class="table table-sm table-sm-font w-auto"
                data-filter-control="true"
                hidden
            >
                <thead>
                    <tr class="secondary">
                        <th class="align-middle" data-field="cancer_type" data-filter-control="input" data-halign="center" data-sortable="true" data-width="150">Cancer type</th>
                        <th class="align-middle" data-field="is_haemonc" data-align="center" data-halign="center" data-sortable="true" data-width="50">HaemOnc</th>
                        <th class="align-middle" data-field="same_nucleotide_change_pc" data-align="right" data-halign="center" data-sortable="true" data-width="50">Same nucleotide<br>change patient count</th>
                        <th class="align-middle" data-field="same_amino_acid_change_pc" data-align="right" data-halign="center" data-sortable="true" data-width="50">Same amino acid change<br>patient count</th>
                        <th class="align-middle" data-field="same_or_downstream_truncating_variants_per_cds_pc" data-align="right" data-halign="center" data-sortable="true" data-width="50">Same or downstream truncating <br>variants per CDS patient count</th>
                        <th class="align-middle" data-field="nested_inframe_deletions_per_cds_pc" data-align="right" data-halign="center" data-sortable="true" data-width="50">Nested inframe deletions<br>per CDS patient count</th>
                        <th class="align-middle" data-field="cancer_n" data-halign="center" data-align="right" data-sortable="true" data-width="50">Total cancer<br>patient count</th>
                    </tr>
                </thead>
            </table>
        `
        return html
    }
</script>
{% endblock %}